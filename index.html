<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kasam Connekt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: {"50":"#eff6ff","100":"#dbeafe","200":"#bfdbfe","300":"#93c5fd","400":"#60a5fa","500":"#3b82f6","600":"#2563eb","700":"#1d4ed8","800":"#1e40af","900":"#1e3a8a","950":"#172554"}
            }
          }
        }
      }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.26.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.3.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
</head>
  <body class="bg-gray-50 dark:bg-gray-900">
    <div id="root"></div>
    <script type="module">
import React from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from '@google/genai';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';

// --- Firebase Initialization ---
const firebaseConfig = {
  apiKey: "AIzaSyCSxPL4Fl5ajsMJG8jVcbek-aHEvMclVug",
  authDomain: "kasam-connekt.firebaseapp.com",
  projectId: "kasam-connekt",
  storageBucket: "kasam-connekt.firebasestorage.app",
  messagingSenderId: "844196020427",
  appId: "1:844196020427:web:b6b4882a212646bf36db4e",
  measurementId: "G-CKFC4JWT0X"
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const storage = firebase.storage();
const db = firebase.firestore();

// --- Inlined Code from all files ---

// --- types.ts ---
const Role = {
  STORE_MANAGER: 'Store Manager',
  CLUSTER_MANAGER: 'Cluster Manager',
  DEPARTMENT_SPECIALIST: 'Department Specialist',
  OPERATIONS_HEAD: 'Operations Head',
  ADMIN: 'Admin',
};
const Status = {
  RAISED: 'Raised',
  ASSIGNED: 'Assigned',
  IN_PROGRESS: 'In Progress',
  COMPLETED: 'Completed',
  PENDING_CLOSURE: 'Pending Closure',
  CLOSED: 'Closed',
};
const Category = {
  MAINTENANCE: 'Maintenance',
  HR: 'HR',
  INVENTORY: 'Inventory',
  IT: 'IT Support',
  OPERATIONS: 'Operations',
  VISUALMERCHANDIZING: 'Visual Merchandizing',
  ACCOUNTS: 'Accounts',
};

// --- icons/Icons.tsx ---
const SunIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M12 21a9 9 0 110-18 9 9 0 010 18z" })
  )
);
const MoonIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" })
  )
);
const UserCircleIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" })
  )
);
const ChartBarIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" })
  )
);
const TicketIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-1.5h5.25m-5.25 0h3m-3 0h-3m2.25 0H5.625M17.25 6H6.75a3.375 3.375 0 00-3.375 3.375v5.25a3.375 3.375 0 003.375 3.375h10.5a3.375 3.375 0 003.375-3.375v-5.25a3.375 3.375 0 00-3.375-3.375z" })
  )
);
const BuildingStorefrontIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M13.5 21v-7.5A.75.75 0 0114.25 12h.75c.414 0 .75.336.75.75v7.5m0 0H18M15 21h.75m-1.5 0H12m3 0h.75M15 21h-1.5m0 0H9m3.75 0h1.5M9 12v9M9 21H6m3-9H6.75A.75.75 0 006 12.75v7.5c0 .414.336.75.75.75h.75m3-9H6m3 0h.75m-1.5 0H9m3 0h.75M9 12l.75-1.5m0 0l.75-1.5m-1.5 3l-1.5-3m0 0l.75 1.5m-1.5-3l1.5 3m0 0l.75-1.5m-1.5 3l-1.5-3m1.5-3l.75-1.5m-1.5 3l.75 1.5m6-13.5l-3 4.5m0 0l-3-4.5m3 4.5v6.75m0 0l-3-4.5m3 4.5l3-4.5m-3-4.5l3 4.5" })
  )
);
const PlusIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M12 4.5v15m7.5-7.5h-15" })
  )
);
const SearchIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" })
  )
);
const CalendarIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" })
  )
);
const UserIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" })
  )
);
const TagIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" }),
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M6 6h.008v.008H6V6z" })
  )
);
const XMarkIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M6 18L18 6M6 6l12 12" })
  )
);
const ChatBubbleLeftRightIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.72-3.72a1.063 1.063 0 00-1.5 0l-3.72 3.72A2.123 2.123 0 013 16.899v-4.286c0-.97.616-1.813 1.5-2.097m16.5 0a2.123 2.123 0 00-1.5-2.097m-15 0A2.123 2.123 0 013 6.414v-1.872c0-1.136.847-2.1 1.98-2.193l3.72 3.72a1.063 1.063 0 001.5 0l3.72-3.72A2.123 2.123 0 0118 4.542v1.872c0 .97-.616 1.813-1.5 2.097m-15 0m15 0" })
  )
);
const ClockIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" })
  )
);
const SparklesIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.455-2.456L12.75 18l1.178-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.25 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" })
  )
);
const ArrowPathIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-14.994-1.581v-4.992m0 0h4.992m-4.993 0l3.181-3.183a8.25 8.25 0 0111.664 0l3.18 3.185" })
  )
);
const ArrowDownTrayIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" })
  )
);
const UsersIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5zM10.5 18.75a9 9 0 10-9-9 9 9 0 009 9z" })
  )
);
const PencilIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" })
  )
);
const TrashIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.033-2.134H8.033C6.91 2.75 6 3.704 6 4.884v.916m7.5 0a48.667 48.667 0 00-7.5 0" })
  )
);
const KeyIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" })
  )
);
const CheckCircleIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" })
  )
);
const XCircleIcon = (props) => (
  React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" })
  )
);
const PaperClipIcon = (props) => (
    React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
      React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3.375 3.375 0 1118.375 7.625l-10.94 10.94a1.125 1.125 0 11-1.591-1.591l10.94-10.94a3.375 3.375 0 014.773 4.773l-10.94 10.94a1.125 1.125 0 101.591 1.591l7.693-7.693a4.5 4.5 0 00-6.364-6.364l-7.693 7.693" })
    )
);
const ArrowLeftOnRectangleIcon = (props) => (
    React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" },
        React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" })
    )
);


// --- constants.ts ---
const INITIAL_USERS = [
  // Admins
  { id: 'user-admin-1', name: 'Admin User', role: Role.ADMIN, email: 'admin@retailops.com', password: 'password123', passwordChanged: false },
  // Operations Heads
  { id: 'user-ops-1', name: 'Olivia Payne', role: Role.OPERATIONS_HEAD, email: 'olivia.payne@retailops.com', password: 'password' },
  { id: 'user-ops-2', name: 'Omar Hughes', role: Role.OPERATIONS_HEAD, email: 'omar.hughes@retailops.com', password: 'password' },
  // Cluster Managers
  { id: 'user-cm-1', name: 'Charles Miller', role: Role.CLUSTER_MANAGER, cluster: 'North Cluster', email: 'charles.miller@retailops.com', password: 'password' },
  { id: 'user-cm-2', name: 'Chloe Davis', role: Role.CLUSTER_MANAGER, cluster: 'South Cluster', email: 'chloe.davis@retailops.com', password: 'password' },
  // Department Specialists
  { id: 'user-ds-1', name: 'John Smith', role: Role.DEPARTMENT_SPECIALIST, email: 'john.smith.it@retailops.com', password: 'password' },
  { id: 'user-ds-2', name: 'Jane Doe', role: Role.DEPARTMENT_SPECIALIST, email: 'jane.doe.hr@retailops.com', password: 'password' },
  { id: 'user-ds-3', name: 'Peter Jones', role: Role.DEPARTMENT_SPECIALIST, email: 'peter.jones.maint@retailops.com', password: 'password' },
  { id: 'user-ds-4', name: 'Mary Williams', role: Role.DEPARTMENT_SPECIALIST, email: 'mary.williams.acc@retailops.com', password: 'password' },
  { id: 'user-ds-5', name: 'David Brown', role: Role.DEPARTMENT_SPECIALIST, email: 'david.brown.acc@retailops.com', password: 'password' },
  // Store Managers
  { id: 'user-sm-1', name: 'Sophie Morgan', role: Role.STORE_MANAGER, store: 'Downtown Central', email: 'sophie.morgan@retailops.com', password: 'password' },
  { id: 'user-sm-2', name: 'Samuel Myers', role: Role.STORE_MANAGER, store: 'Uptown Plaza', email: 'samuel.myers@retailops.com', password: 'password' },
  { id: 'user-sm-3', name: 'Scarlett Mitchell', role: Role.STORE_MANAGER, store: 'Westside Mall', email: 'scarlett.mitchell@retailops.com', password: 'password' },
  { id: 'user-sm-4', name: 'Sebastian Martin', role: Role.STORE_MANAGER, store: 'Eastside Market', email: 'sebastian.martin@retailops.com', password: 'password' },
];

const INITIAL_TICKETS = [
  { id: 'TICKET-001', title: 'Leaking AC unit in main aisle', description: 'The main air conditioning unit in aisle 5 has been leaking water for the past two hours...', status: Status.ASSIGNED, category: Category.MAINTENANCE, priority: 'High', raisedBy: 'user-sm-1', store: 'Downtown Central', assignedTo: 'user-ds-3', assignedClusterManager: 'user-cm-1', createdAt: '2023-10-26T09:00:00Z', updatedAt: '2023-10-26T09:00:00Z', comments: [], history: [ { status: Status.RAISED, timestamp: '2023-10-26T09:00:00Z', updatedBy: 'user-sm-1' }, { status: Status.ASSIGNED, timestamp: '2023-10-26T09:00:01Z', updatedBy: 'user-ds-3' } ], fileAttachments: [] },
  { id: 'TICKET-002', title: 'POS Terminal 2 not processing cards', description: 'Credit card reader on POS 2 is declining all cards...', status: Status.IN_PROGRESS, category: Category.IT, priority: 'High', raisedBy: 'user-sm-2', store: 'Uptown Plaza', assignedTo: 'user-ds-1', assignedClusterManager: 'user-cm-1', createdAt: '2023-10-26T10:30:00Z', updatedAt: '2023-10-26T11:00:00Z', comments: [ { id: 'C-001', user: 'user-ds-1', text: 'Looking into this remotely.', timestamp: '2023-10-26T11:00:00Z'} ], history: [ { status: Status.RAISED, timestamp: '2023-10-26T10:30:00Z', updatedBy: 'user-sm-2' }, { status: Status.ASSIGNED, timestamp: '2023-10-26T10:30:01Z', updatedBy: 'user-ds-1' }, { status: Status.IN_PROGRESS, timestamp: '2023-10-26T11:00:00Z', updatedBy: 'user-ds-1' } ], fileAttachments: [] },
  { id: 'TICKET-003', title: 'Request new cashier training', description: 'Two new hires need POS and customer service training.', status: Status.PENDING_CLOSURE, category: Category.HR, priority: 'Medium', raisedBy: 'user-sm-3', store: 'Westside Mall', assignedTo: 'user-ds-2', assignedClusterManager: 'user-cm-2', closureRequestedBy: 'user-sm-3', createdAt: '2023-10-25T14:00:00Z', updatedAt: '2023-10-26T08:30:00Z', comments: [ { id: 'C-003', user: 'user-ds-2', text: 'Training scheduled.', timestamp: '2023-10-26T08:00:00Z'} ], history: [ { status: Status.RAISED, timestamp: '2023-10-25T14:00:00Z', updatedBy: 'user-sm-3' }, { status: Status.ASSIGNED, timestamp: '2023-10-25T14:00:01Z', updatedBy: 'user-ds-2' }, { status: Status.IN_PROGRESS, timestamp: '2023-10-25T15:00:00Z', updatedBy: 'user-ds-2' }, { status: Status.COMPLETED, timestamp: '2023-10-26T08:00:00Z', updatedBy: 'user-ds-2' }, { status: Status.PENDING_CLOSURE, timestamp: '2023-10-26T08:30:00Z', updatedBy: 'user-sm-3' } ], fileAttachments: [] },
];

const INITIAL_CATEGORY_ASSIGNMENTS = {
    [Category.IT]: ['user-ds-1'],
    [Category.HR]: ['user-ds-2'],
    [Category.MAINTENANCE]: ['user-ds-3'],
    [Category.ACCOUNTS]: ['user-ds-4', 'user-ds-5'],
};

// --- contexts/AppContext.ts ---
const AppContext = React.createContext(null);

// --- components/UserModal.tsx ---
const UserModal = ({ isOpen, onClose, userToEdit }) => {
  const context = React.useContext(AppContext);
  const [name, setName] = React.useState('');
  const [role, setRole] = React.useState(Role.STORE_MANAGER);
  const [email, setEmail] = React.useState('');
  const [store, setStore] = React.useState('');
  const [cluster, setCluster] = React.useState('');
  const [password, setPassword] = React.useState('');
  const isEditing = !!userToEdit;

  React.useEffect(() => {
    if (isOpen) {
        if (isEditing) {
          setName(userToEdit.name);
          setRole(userToEdit.role);
          setEmail(userToEdit.email || '');
          setStore(userToEdit.store || '');
          setCluster(userToEdit.cluster || '');
          setPassword(''); // Clear password field on edit
        } else {
          setName('');
          setRole(Role.STORE_MANAGER);
          setEmail('');
          setStore('');
          setCluster('');
          setPassword('');
        }
    }
  }, [userToEdit, isEditing, isOpen]);

  if (!context || !isOpen) return null;
  const { createUser, updateUser, changePassword } = context;

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!name || !email) return;
    if (!isEditing && !password) {
        alert("Please set an initial password for the new user.");
        return;
    }

    const userData = {
      name,
      role,
      email,
      store: role === Role.STORE_MANAGER ? store : null,
      cluster: role === Role.CLUSTER_MANAGER ? cluster : null,
    };

    if (isEditing) {
      updateUser(userToEdit.id, userData);
      if (password) {
          changePassword(userToEdit.id, password);
      }
    } else {
      createUser(userData, password);
    }
    onClose();
  };
  
  const handleRoleChange = (e) => {
    const newRole = e.target.value;
    setRole(newRole);
    if (newRole !== Role.STORE_MANAGER) setStore('');
    if (newRole !== Role.CLUSTER_MANAGER) setCluster('');
  };

  return React.createElement('div', { className: "fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4", onClick: onClose },
    React.createElement('div', { className: "bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md", onClick: e => e.stopPropagation() },
      React.createElement('header', { className: "flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700" },
        React.createElement('h2', { className: "text-xl font-bold text-gray-900 dark:text-white" }, isEditing ? 'Edit User' : 'Add New User'),
        React.createElement('button', { onClick: onClose, className: "p-1 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600" }, React.createElement(XMarkIcon, { className: "h-6 w-6" }))
      ),
      React.createElement('form', { onSubmit: handleSubmit },
        React.createElement('main', { className: "p-6 space-y-4" },
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "name", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Full Name"),
            React.createElement('input', { type: "text", id: "name", value: name, onChange: e => setName(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
          ),
           React.createElement('div', null,
            React.createElement('label', { htmlFor: "email", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Email Address"),
            React.createElement('input', { type: "email", id: "email", value: email, onChange: e => setEmail(e.target.value), placeholder: "user@example.com", required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
          ),
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "password", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, isEditing ? "New Password (optional)" : "Password"),
            React.createElement('input', { type: "password", id: "password", value: password, onChange: e => setPassword(e.target.value), required: !isEditing, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
          ),
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "role", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Role"),
            React.createElement('select', { id: "role", value: role, onChange: handleRoleChange, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" },
              Object.values(Role).map(r => React.createElement('option', { key: r, value: r }, r))
            )
          ),
          role === Role.STORE_MANAGER && React.createElement('div', null,
            React.createElement('label', { htmlFor: "store", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Store Name"),
            React.createElement('input', { type: "text", id: "store", value: store, onChange: e => setStore(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
          ),
          role === Role.CLUSTER_MANAGER && React.createElement('div', null,
            React.createElement('label', { htmlFor: "cluster", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Cluster Name"),
            React.createElement('input', { type: "text", id: "cluster", value: cluster, onChange: e => setCluster(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
          )
        ),
        React.createElement('footer', { className: "flex justify-end p-4 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-700 gap-3" },
          React.createElement('button', { type: "button", onClick: onClose, className: "rounded-md bg-white dark:bg-gray-600 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500" }, "Cancel"),
          React.createElement('button', { type: "submit", className: "rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2" }, isEditing ? 'Save Changes' : 'Create User')
        )
      )
    )
  );
};

// --- views/UserManagement.tsx ---
const UserManagement = () => {
  const context = React.useContext(AppContext);
  const [isModalOpen, setIsModalOpen] = React.useState(false);
  const [editingUser, setEditingUser] = React.useState(null);
  
  if (!context) return null;
  
  const departmentSpecialists = React.useMemo(() => {
    return (context?.users || []).filter(user => user.role === Role.DEPARTMENT_SPECIALIST);
  }, [context?.users]);
  
  const { users, deleteUser, categoryAssignments, updateCategoryAssignment } = context;
  
  const handleOpenModal = (user = null) => {
    setEditingUser(user);
    setIsModalOpen(true);
  };
  const handleCloseModal = () => {
    setIsModalOpen(false);
    setEditingUser(null);
  };
  const handleDeleteUser = (userId) => {
    if (window.confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
      deleteUser(userId);
    }
  };

  return React.createElement(React.Fragment, null,
    React.createElement('div', { className: "space-y-8" },
      React.createElement('div', null,
        React.createElement('div', { className: "flex flex-col md:flex-row items-center justify-between gap-4 mb-6" },
          React.createElement('div', null,
            React.createElement('h1', { className: "text-3xl font-bold tracking-tight text-gray-900 dark:text-white" }, "User Management"),
            React.createElement('p', { className: "text-gray-500 dark:text-gray-400 mt-1" }, "Add, edit, or remove users from the system.")
          ),
          React.createElement('button', { onClick: () => handleOpenModal(), className: "inline-flex items-center justify-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800" },
            React.createElement(PlusIcon, { className: "h-5 w-5 mr-2" }), "Add New User"
          )
        ),
        React.createElement('div', { className: "bg-white dark:bg-gray-800 shadow-sm rounded-lg overflow-hidden" },
          React.createElement('div', { className: "overflow-x-auto" },
            React.createElement('table', { className: "min-w-full divide-y divide-gray-200 dark:divide-gray-700" },
              React.createElement('thead', { className: "bg-gray-50 dark:bg-gray-700" },
                React.createElement('tr', null,
                  React.createElement('th', { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" }, "Name"),
                  React.createElement('th', { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" }, "Role"),
                  React.createElement('th', { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" }, "Assignment (Store/Cluster)"),
                  React.createElement('th', { scope: "col", className: "relative px-6 py-3" }, React.createElement('span', { className: "sr-only" }, "Actions"))
                )
              ),
              React.createElement('tbody', { className: "bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" },
                users.length > 0 ? users.map(user => React.createElement('tr', { key: user.id },
                  React.createElement('td', { className: "px-6 py-4 whitespace-nowrap" },
                    React.createElement('div', { className: "text-sm font-medium text-gray-900 dark:text-white" }, user.name),
                    React.createElement('div', { className: "text-sm text-gray-500 dark:text-gray-400" }, user.email)
                  ),
                  React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300" }, user.role),
                  React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300" }, user.store || user.cluster || 'N/A'),
                  React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2" },
                    React.createElement('button', { onClick: () => handleOpenModal(user), className: "text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-200 p-1", title: "Edit User / Change Password" }, React.createElement(PencilIcon, { className: "h-5 w-5" })),
                    React.createElement('button', { onClick: () => handleDeleteUser(user.id), className: "text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200 p-1", title: "Delete User" }, React.createElement(TrashIcon, { className: "h-5 w-5" }))
                  )
                )) : React.createElement('tr', null,
                  React.createElement('td', { colSpan: 4, className: "text-center py-12" },
                    React.createElement(UsersIcon, { className: "mx-auto h-12 w-12 text-gray-400" }),
                    React.createElement('h3', { className: "mt-2 text-sm font-medium text-gray-900 dark:text-white" }, "No users found"),
                    React.createElement('p', { className: "mt-1 text-sm text-gray-500 dark:text-gray-400" }, "Click \"Add New User\" to get started.")
                  )
                )
              )
            )
          )
        )
      ),
      React.createElement('div', null,
        React.createElement('div', { className: "mb-6" },
          React.createElement('h1', { className: "text-3xl font-bold tracking-tight text-gray-900 dark:text-white" }, "Category Assignments"),
          React.createElement('p', { className: "text-gray-500 dark:text-gray-400 mt-1" }, "Assign multiple specialists to each category for team-based ticket routing.")
        ),
        React.createElement('div', { className: "bg-white dark:bg-gray-800 shadow-sm rounded-lg p-6" },
          React.createElement('div', { className: "space-y-6" },
            Object.values(Category).map(category => React.createElement('div', { key: category, className: "border-b border-gray-200 dark:border-gray-700 pb-6 last:border-b-0 last:pb-0" },
              React.createElement('div', { className: "flex items-center mb-4" },
                React.createElement(TagIcon, { className: "h-5 w-5 text-gray-400 mr-3" }),
                React.createElement('h3', { className: "text-lg font-medium text-gray-800 dark:text-gray-200" }, category)
              ),
              React.createElement('div', { className: "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" },
                departmentSpecialists.map(specialist => React.createElement('label', { key: specialist.id, className: "flex items-center space-x-3" },
                  React.createElement('input', {
                    type: "checkbox",
                    checked: categoryAssignments[category]?.includes(specialist.id) || false,
                    onChange: (e) => updateCategoryAssignment(category, specialist.id, e.target.checked),
                    className: "h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                  }),
                  React.createElement('span', { className: "text-sm text-gray-700 dark:text-gray-300" }, specialist.name)
                ))
              )
            ))
          ),
          departmentSpecialists.length === 0 && React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400 text-center py-4" }, "No \"Department Specialist\" users found. Please add users with this role to assign them to categories.")
        )
      )
    ),
    isModalOpen && React.createElement(UserModal, { isOpen: isModalOpen, onClose: handleCloseModal, userToEdit: editingUser })
  );
};

// --- views/AdminAnalytics.tsx ---
const COLORS = ['#EF4444', '#3B82F6', '#EAB308', '#22C55E', '#8B5CF6', '#6B7280'];
const RADIAN = Math.PI / 180;
const renderCustomizedLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent }) => {
  const radius = innerRadius + (outerRadius - innerRadius) * 0.5;
  const x = cx + radius * Math.cos(-midAngle * RADIAN);
  const y = cy + radius * Math.sin(-midAngle * RADIAN);
  if (percent === 0) return null;
  return React.createElement('text', { x: x, y: y, fill: "white", textAnchor: x > cx ? 'start' : 'end', dominantBaseline: "central" }, `${(percent * 100).toFixed(0)}%`);
};
const AdminAnalytics = () => {
  const context = React.useContext(AppContext);

  const ticketsByStatus = React.useMemo(() => {
    const statusCounts = Object.values(Status).reduce((acc, status) => {
      acc[status] = 0;
      return acc;
    }, {});
    (context?.allTickets || []).forEach(ticket => {
      statusCounts[ticket.status]++;
    });
    const orderedStatuses = [Status.RAISED, Status.ASSIGNED, Status.IN_PROGRESS, Status.COMPLETED, Status.PENDING_CLOSURE, Status.CLOSED];
    return orderedStatuses.map(status => ({ name: status, value: statusCounts[status] }));
  }, [context?.allTickets]);

  const ticketsByCluster = React.useMemo(() => {
    const clusterManagers = (context?.users || []).filter(u => u.role === Role.CLUSTER_MANAGER);
    const clusterCounts = {};
    clusterManagers.forEach(cm => {
      if (cm.cluster) clusterCounts[cm.cluster] = { total: 0, closed: 0 };
    });
    (context?.allTickets || []).forEach(ticket => {
      const clusterName = ticket.assignedClusterManager?.cluster;
      if (clusterName && clusterCounts[clusterName]) {
        clusterCounts[clusterName].total++;
        if (ticket.status === Status.CLOSED) {
          clusterCounts[clusterName].closed++;
        }
      }
    });
    return Object.entries(clusterCounts).map(([name, data]) => ({ name, ...data }));
  }, [context?.allTickets, context?.users]);

  if (!context) return null;
  const { allTickets } = context;
  const totalTickets = allTickets.length;
  const openTickets = allTickets.filter(t => t.status !== Status.CLOSED).length;
  return React.createElement('div', { className: "space-y-6" },
    React.createElement('div', null,
      React.createElement('h1', { className: "text-3xl font-bold tracking-tight text-gray-900 dark:text-white" }, "Performance Analytics"),
      React.createElement('p', { className: "text-gray-500 dark:text-gray-400 mt-1" }, "An overview of ticket resolution and performance metrics.")
    ),
    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" },
      React.createElement('div', { className: "bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm" },
        React.createElement('h3', { className: "text-sm font-medium text-gray-500 dark:text-gray-400" }, "Total Tickets"),
        React.createElement('p', { className: "mt-2 text-3xl font-bold text-gray-900 dark:text-white" }, totalTickets)
      ),
      React.createElement('div', { className: "bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm" },
        React.createElement('h3', { className: "text-sm font-medium text-gray-500 dark:text-gray-400" }, "Open Tickets"),
        React.createElement('p', { className: "mt-2 text-3xl font-bold text-red-600 dark:text-red-400" }, openTickets)
      ),
      React.createElement('div', { className: "bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm" },
        React.createElement('h3', { className: "text-sm font-medium text-gray-500 dark:text-gray-400" }, "Closed Tickets"),
        React.createElement('p', { className: "mt-2 text-3xl font-bold text-green-600 dark:text-green-400" }, totalTickets - openTickets)
      ),
      React.createElement('div', { className: "bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm" },
        React.createElement('h3', { className: "text-sm font-medium text-gray-500 dark:text-gray-400" }, "Resolution Rate"),
        React.createElement('p', { className: "mt-2 text-3xl font-bold text-primary-600 dark:text-primary-400" }, totalTickets > 0 ? `${(((totalTickets - openTickets) / totalTickets) * 100).toFixed(1)}%` : 'N/A')
      )
    ),
    React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-5 gap-6" },
      React.createElement('div', { className: "lg:col-span-3 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm" },
        React.createElement('h3', { className: "text-lg font-medium text-gray-900 dark:text-white mb-4" }, "Tickets by Cluster"),
        React.createElement(ResponsiveContainer, { width: "100%", height: 300 },
          React.createElement(BarChart, { data: ticketsByCluster },
            React.createElement(CartesianGrid, { strokeDasharray: "3 3", vertical: false, className: "stroke-gray-200 dark:stroke-gray-700" }),
            React.createElement(XAxis, { dataKey: "name", className: "text-xs" }),
            React.createElement(YAxis, { allowDecimals: false, className: "text-xs" }),
            React.createElement(Tooltip, { contentStyle: { backgroundColor: 'rgba(255, 255, 255, 0.8)', backdropFilter: 'blur(5px)', border: '1px solid #ccc', borderRadius: '0.5rem' } }),
            React.createElement(Legend, { wrapperStyle: { fontSize: "0.8rem" } }),
            React.createElement(Bar, { dataKey: "total", fill: "#3b82f6", name: "Total Tickets" }),
            React.createElement(Bar, { dataKey: "closed", fill: "#22c55e", name: "Closed Tickets" })
          )
        )
      ),
      React.createElement('div', { className: "lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm" },
        React.createElement('h3', { className: "text-lg font-medium text-gray-900 dark:text-white mb-4" }, "Tickets by Status"),
        React.createElement(ResponsiveContainer, { width: "100%", height: 300 },
          React.createElement(PieChart, null,
            React.createElement(Pie, { data: ticketsByStatus, cx: "50%", cy: "50%", labelLine: false, label: renderCustomizedLabel, outerRadius: 100, fill: "#8884d8", dataKey: "value" },
              ticketsByStatus.map((entry, index) => React.createElement(Cell, { key: `cell-${index}`, fill: COLORS[index % COLORS.length] }))
            ),
            React.createElement(Tooltip, null),
            React.createElement(Legend, { iconType: "circle", wrapperStyle: { fontSize: "0.8rem" } })
          )
        )
      )
    )
  );
};

// --- components/CreateTicketModal.tsx ---
const CreateTicketModal = ({ isOpen, onClose }) => {
  const context = React.useContext(AppContext);
  const [title, setTitle] = React.useState('');
  const [description, setDescription] = React.useState('');
  const [category, setCategory] = React.useState(Category.MAINTENANCE);
  const [priority, setPriority] = React.useState('Medium');
  const [clusterManagerId, setClusterManagerId] = React.useState('');
  const [files, setFiles] = React.useState([]);
  const [isUploading, setIsUploading] = React.useState(false);

  const clusterManagers = React.useMemo(() => (context?.users || []).filter(u => u.role === Role.CLUSTER_MANAGER), [context?.users]);

  const resetState = React.useCallback(() => {
    setTitle('');
    setDescription('');
    setCategory(Category.MAINTENANCE);
    setPriority('Medium');
    setClusterManagerId(clusterManagers.length > 0 ? clusterManagers[0].id : '');
    setFiles([]);
    setIsUploading(false);
  }, [clusterManagers]);

  React.useEffect(() => {
    if (isOpen && clusterManagers.length > 0 && !clusterManagerId) {
        setClusterManagerId(clusterManagers[0].id);
    }
  }, [isOpen, clusterManagers, clusterManagerId]);


  if (!context || !isOpen) return null;
  const { currentUser, createTicket } = context;

  const handleFileChange = (e) => {
    if (e.target.files) {
        setFiles(Array.from(e.target.files));
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!title || !description || !currentUser.store || !clusterManagerId) {
      alert('Please fill all fields and select a cluster manager.');
      return;
    }

    setIsUploading(true);

    const ticketId = `TICKET-${String(Date.now()).slice(-4)}`;
    let fileAttachments = [];

    if (files.length > 0) {
        try {
            const uploadPromises = files.map(file => {
                const storageRef = storage.ref(`attachments/${ticketId}/${file.name}`);
                return storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
            });
            
            const downloadUrls = await Promise.all(uploadPromises);

            fileAttachments = files.map((file, index) => ({
                name: file.name,
                url: downloadUrls[index],
            }));
        } catch(error) {
            console.error("Error uploading files:", error);
            alert("There was an error uploading files. Please try again.");
            setIsUploading(false);
            return;
        }
    }

    createTicket({
      id: ticketId,
      title,
      description,
      category,
      priority,
      raisedBy: currentUser.id,
      store: currentUser.store,
      assignedClusterManager: clusterManagerId,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      fileAttachments,
    });
    
    resetState();
    onClose();
  };

  return React.createElement('div', { className: "fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4", onClick: onClose },
    React.createElement('div', { className: "bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg", onClick: e => e.stopPropagation() },
      React.createElement('header', { className: "flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700" },
        React.createElement('h2', { className: "text-xl font-bold text-gray-900 dark:text-white" }, "Raise a New Ticket"),
        React.createElement('button', { onClick: onClose, className: "p-1 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600", disabled: isUploading }, React.createElement(XMarkIcon, { className: "h-6 w-6" }))
      ),
      React.createElement('form', { onSubmit: handleSubmit },
        React.createElement('main', { className: "p-6 space-y-4" },
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "title", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Title"),
            React.createElement('input', { type: "text", id: "title", value: title, onChange: e => setTitle(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
          ),
          React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
            React.createElement('div', null,
              React.createElement('label', { htmlFor: "category", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Category"),
              React.createElement('select', { id: "category", value: category, onChange: e => setCategory(e.target.value), className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" },
                Object.values(Category).map(cat => React.createElement('option', { key: cat, value: cat }, cat))
              )
            ),
            React.createElement('div', null,
              React.createElement('label', { htmlFor: "priority", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Priority"),
              React.createElement('select', { id: "priority", value: priority, onChange: e => setPriority(e.target.value), className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" },
                React.createElement('option', { value: "Low" }, "Low"),
                React.createElement('option', { value: "Medium" }, "Medium"),
                React.createElement('option', { value: "High" }, "High")
              )
            )
          ),
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "clusterManager", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Choose your Cluster Manager"),
            React.createElement('select', { id: "clusterManager", value: clusterManagerId, onChange: e => setClusterManagerId(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" },
              React.createElement('option', { disabled: true, value: "" }, "Select a manager..."),
              clusterManagers.map(cm => React.createElement('option', { key: cm.id, value: cm.id }, `${cm.name} (${cm.cluster})`))
            )
          ),
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "description", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Description"),
            React.createElement('textarea', { id: "description", rows: 4, value: description, onChange: e => setDescription(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
          ),
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "attachments", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Attachments"),
            React.createElement('input', { type: "file", id: "attachments", multiple: true, onChange: handleFileChange, className: "mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary-50 dark:file:bg-primary-800 file:text-primary-700 dark:file:text-primary-200 hover:file:bg-primary-100 dark:hover:file:bg-primary-700" }),
            files.length > 0 && React.createElement('ul', { className: "mt-2 text-sm text-gray-500 dark:text-gray-400 list-disc pl-5" },
                files.map((file, index) => React.createElement('li', { key: index }, file.name))
            )
          )
        ),
        React.createElement('footer', { className: "flex justify-end p-4 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-700 gap-3" },
          React.createElement('button', { type: "button", onClick: onClose, disabled: isUploading, className: "rounded-md bg-white dark:bg-gray-600 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 disabled:opacity-50" }, "Cancel"),
          React.createElement('button', { type: "submit", disabled: isUploading, className: "rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:bg-primary-400 disabled:cursor-not-allowed" }, isUploading ? 'Uploading...' : 'Submit Ticket')
        )
      )
    )
  );
};

// --- components/TicketDetailsModal.tsx ---
const statusStylesModal = {
  [Status.RAISED]: { bg: 'bg-red-100 dark:bg-red-900/50', text: 'text-red-800 dark:text-red-300' },
  [Status.ASSIGNED]: { bg: 'bg-blue-100 dark:bg-blue-900/50', text: 'text-blue-800 dark:text-blue-300' },
  [Status.IN_PROGRESS]: { bg: 'bg-yellow-100 dark:bg-yellow-900/50', text: 'text-yellow-800 dark:text-yellow-300' },
  [Status.COMPLETED]: { bg: 'bg-green-100 dark:bg-green-900/50', text: 'text-green-800 dark:text-green-300' },
  [Status.PENDING_CLOSURE]: { bg: 'bg-purple-100 dark:bg-purple-900/50', text: 'text-purple-800 dark:text-purple-300' },
  [Status.CLOSED]: { bg: 'bg-gray-100 dark:bg-gray-700', text: 'text-gray-800 dark:text-gray-300' },
};
const TicketDetailsModal = ({ isOpen, onClose, ticket }) => {
  const context = React.useContext(AppContext);
  const [activeTab, setActiveTab] = React.useState('comments');
  const [newComment, setNewComment] = React.useState('');
  const [summary, setSummary] = React.useState('');
  const [isSummarizing, setIsSummarizing] = React.useState(false);
  const [rejectionReason, setRejectionReason] = React.useState('');
  const [showRejectionInput, setShowRejectionInput] = React.useState(false);
  const [selectedSpecialistId, setSelectedSpecialistId] = React.useState(null);

  if (!context || !isOpen) return null;

  const isAssignmentChanged = React.useMemo(() => (ticket.assignedTo?.id || null) !== selectedSpecialistId, [selectedSpecialistId, ticket.assignedTo]);

  React.useEffect(() => {
    if (isOpen) {
      setSummary('');
      setIsSummarizing(false);
      setNewComment('');
      setActiveTab('comments');
      setShowRejectionInput(false);
      setRejectionReason('');
      setSelectedSpecialistId(ticket.assignedTo?.id || null);
    }
  }, [isOpen, ticket]);

  const departmentSpecialistsForCategory = React.useMemo(() => {
    if (!context) return [];
    const specialistIds = context.categoryAssignments?.[ticket.category] || [];
    return context.users.filter(u => u.role === Role.DEPARTMENT_SPECIALIST && specialistIds.includes(u.id));
  }, [context, ticket.category]);
  
  const { currentUser, addComment, updateTicketStatus, generateTicketSummary, assignTicketToSelf, assignTicketToSpecialist, requestTicketClosure, approveTicketClosure, rejectTicketClosure } = context;
  
  const handleGenerateSummary = async () => {
    setIsSummarizing(true);
    setSummary('');
    const result = await generateTicketSummary(ticket);
    setSummary(result);
    setIsSummarizing(false);
  };
  const handleAddComment = () => {
    if (newComment.trim()) {
      addComment(ticket.id, newComment.trim());
      setNewComment('');
    }
  };
  const handleRejectClosure = () => {
    if (rejectionReason.trim()) {
      rejectTicketClosure(ticket.id, rejectionReason.trim());
      setRejectionReason('');
      setShowRejectionInput(false);
    } else {
      alert("Please provide a reason for rejection.");
    }
  };
  const handleSaveAssignment = () => {
    if (isAssignmentChanged) {
      assignTicketToSpecialist(ticket.id, selectedSpecialistId);
    }
  };
  const isCurrentUserSpecialistForCategory = React.useMemo(() => {
    if (currentUser.role !== Role.DEPARTMENT_SPECIALIST) return false;
    return context.categoryAssignments?.[ticket.category]?.includes(currentUser.id) ?? false;
  }, [currentUser, ticket.category, context.categoryAssignments]);

  const canAssignToSelf = currentUser.role === Role.DEPARTMENT_SPECIALIST && !ticket.assignedTo && isCurrentUserSpecialistForCategory;
  const canManageAssignment = ((currentUser.role === Role.ADMIN || currentUser.role === Role.OPERATIONS_HEAD) || (currentUser.role === Role.CLUSTER_MANAGER && currentUser.id === ticket.assignedClusterManager?.id)) && ticket.status !== Status.CLOSED;
  const canStartProgress = currentUser.id === ticket.assignedTo?.id && ticket.status === Status.ASSIGNED;
  const canMarkAsComplete = currentUser.id === ticket.assignedTo?.id && ticket.status === Status.IN_PROGRESS;
  const canRequestClosure = (currentUser.id === ticket.raisedBy?.id || currentUser.id === ticket.assignedTo?.id) && ticket.status === Status.COMPLETED;
  const canApproveRejectClosure = [Role.ADMIN, Role.OPERATIONS_HEAD].includes(currentUser.role) && ticket.status === Status.PENDING_CLOSURE;
  
  const renderDetailItem = (Icon, label, value) => React.createElement('div', null,
    React.createElement('dt', { className: "text-sm font-medium text-gray-500 dark:text-gray-400 flex items-center" }, React.createElement(Icon, { className: "h-4 w-4 mr-2" }), label),
    React.createElement('dd', { className: "mt-1 text-sm text-gray-900 dark:text-white" }, value)
  );

  return React.createElement('div', { className: "fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4 transition-opacity", onClick: onClose },
    React.createElement('div', { className: "bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col", onClick: e => e.stopPropagation() },
      React.createElement('header', { className: "flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700" },
        React.createElement('div', null,
          React.createElement('h2', { className: "text-xl font-bold text-gray-900 dark:text-white truncate", title: ticket.title }, ticket.title),
          React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400" }, `ID: ${ticket.id}`)
        ),
        React.createElement('button', { onClick: onClose, className: "p-1 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600" }, React.createElement(XMarkIcon, { className: "h-6 w-6" }))
      ),
      React.createElement('main', { className: "flex-grow overflow-y-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6" },
        React.createElement('div', { className: "lg:col-span-1 space-y-6" },
          React.createElement('dl', { className: "grid grid-cols-2 gap-x-4 gap-y-6" },
            React.createElement('div', null,
              React.createElement('dt', { className: "text-sm font-medium text-gray-500 dark:text-gray-400" }, "Status"),
              React.createElement('dd', { className: "mt-1" }, React.createElement('span', { className: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusStylesModal[ticket.status].bg} ${statusStylesModal[ticket.status].text}` }, ticket.status))
            ),
            React.createElement('div', null,
              React.createElement('dt', { className: "text-sm font-medium text-gray-500 dark:text-gray-400" }, "Priority"),
              React.createElement('dd', { className: `mt-1 text-sm font-semibold ${ticket.priority === 'High' ? 'text-red-500' : ticket.priority === 'Medium' ? 'text-yellow-500' : 'text-green-500'}` }, ticket.priority)
            ),
            React.createElement('div', { className: "col-span-2" }, renderDetailItem(TagIcon, "Category", ticket.category)),
            React.createElement('div', { className: "col-span-2" }, renderDetailItem(UserIcon, "Raised By", `${ticket.raisedBy?.name || '...'} (${ticket.store})`)),
            React.createElement('div', { className: "col-span-2" }, renderDetailItem(UserIcon, "Cluster Manager", ticket.assignedClusterManager?.name || 'N/A')),
            React.createElement('div', { className: "col-span-2" }, renderDetailItem(UserIcon, "Assigned To", canManageAssignment ? React.createElement('div', { className: "flex items-center gap-2 mt-1" }, React.createElement('select', { value: selectedSpecialistId || '', onChange: (e) => setSelectedSpecialistId(e.target.value || null), className: "block w-full text-sm rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500" }, React.createElement('option', { value: "" }, "Unassigned"), departmentSpecialistsForCategory.length > 0 ? departmentSpecialistsForCategory.map(ds => React.createElement('option', { key: ds.id, value: ds.id }, ds.name)) : React.createElement('option', { disabled: true }, "No specialists for this category"))) : (ticket.assignedTo?.name || 'Unassigned'))),
            React.createElement('div', { className: "col-span-1" }, renderDetailItem(CalendarIcon, "Created On", new Date(ticket.createdAt).toLocaleString())),
            React.createElement('div', { className: "col-span-1" }, renderDetailItem(CalendarIcon, "Last Updated", new Date(ticket.updatedAt).toLocaleString()))
          ),
          React.createElement('div', { className: "space-y-2" },
            React.createElement('h4', { className: "text-sm font-medium text-gray-500 dark:text-gray-400" }, "Description"),
            React.createElement('p', { className: "text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" }, ticket.description)
          ),
          ticket.fileAttachments && ticket.fileAttachments.length > 0 && React.createElement('div', { className: "space-y-2" },
            renderDetailItem(PaperClipIcon, "Attachments", React.createElement('ul', { className: "mt-1 space-y-1" },
              ticket.fileAttachments.map(file => React.createElement('li', { key: file.url }, React.createElement('a', { href: file.url, target: "_blank", rel: "noopener noreferrer", className: "text-primary-600 dark:text-primary-400 hover:underline" }, file.name)))
            ))
          ),
          React.createElement('div', { className: "space-y-2" },
            React.createElement('button', { onClick: handleGenerateSummary, disabled: isSummarizing, className: "inline-flex items-center text-sm font-medium text-primary-600 dark:text-primary-400 hover:underline disabled:opacity-50 disabled:cursor-not-allowed" },
              isSummarizing ? React.createElement(ArrowPathIcon, { className: "h-4 w-4 mr-2 animate-spin" }) : React.createElement(SparklesIcon, { className: "h-4 w-4 mr-2" }), isSummarizing ? 'Generating...' : 'Generate AI Summary'
            ),
            summary && React.createElement('p', { className: "text-sm bg-primary-50 dark:bg-primary-900/20 p-3 rounded-md border border-primary-200 dark:border-primary-700 text-primary-800 dark:text-primary-200" }, summary)
          )
        ),
        React.createElement('div', { className: "lg:col-span-2" },
          React.createElement('div', { className: "border-b border-gray-200 dark:border-gray-700" },
            React.createElement('nav', { className: "-mb-px flex space-x-6", "aria-label": "Tabs" },
              React.createElement('button', { onClick: () => setActiveTab('comments'), className: `${activeTab === 'comments' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm` }, React.createElement(ChatBubbleLeftRightIcon, { className: "h-5 w-5 mr-2 inline" }), ` Comments (${ticket.comments.length})`),
              React.createElement('button', { onClick: () => setActiveTab('history'), className: `${activeTab === 'history' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm` }, React.createElement(ClockIcon, { className: "h-5 w-5 mr-2 inline" }), ` History (${ticket.history.length})`)
            )
          ),
          React.createElement('div', { className: "mt-4" },
            activeTab === 'comments' && React.createElement('div', { className: "space-y-4" },
              React.createElement('div', { className: "max-h-64 overflow-y-auto pr-2 space-y-4" },
                ticket.comments.length > 0 ? [...ticket.comments].reverse().map(comment => React.createElement('div', { key: comment.id, className: "flex items-start space-x-3" },
                  React.createElement('div', { className: "flex-shrink-0" }, React.createElement(UserCircleIcon, { className: "h-8 w-8 text-gray-400" })),
                  React.createElement('div', { className: "min-w-0 flex-1 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg" },
                    React.createElement('p', { className: "text-sm font-medium text-gray-900 dark:text-white" }, comment.user?.name || 'Unknown User'),
                    React.createElement('p', { className: "text-sm text-gray-600 dark:text-gray-300 mt-1 whitespace-pre-wrap" }, comment.text),
                    React.createElement('p', { className: "text-xs text-gray-500 dark:text-gray-400 mt-2" }, new Date(comment.timestamp).toLocaleString())
                  )
                )) : React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400 text-center py-4" }, "No comments yet.")
              ),
              ticket.status !== Status.CLOSED && React.createElement('div', { className: "pt-4 border-t border-gray-200 dark:border-gray-700" },
                React.createElement('textarea', { rows: 3, value: newComment, onChange: e => setNewComment(e.target.value), placeholder: "Add a comment...", className: "block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" }),
                React.createElement('div', { className: "mt-2 flex justify-end" }, React.createElement('button', { onClick: handleAddComment, className: "rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700" }, "Post Comment"))
              )
            ),
            activeTab === 'history' && React.createElement('ul', { className: "space-y-3" },
              [...ticket.history].reverse().map((event, index) => React.createElement('li', { key: index, className: "flex items-start" },
                React.createElement('div', { className: "flex-shrink-0" }, React.createElement('div', { className: `h-2 w-2 rounded-full mt-1.5 ${statusStylesModal[event.status].bg}` })),
                React.createElement('div', { className: "ml-3" },
                  React.createElement('p', { className: "text-sm text-gray-700 dark:text-gray-300" }, `Status changed to `, React.createElement('span', { className: `font-medium ${statusStylesModal[event.status].text}` }, event.status), ` by ${event.updatedBy?.name || 'Unknown User'}.`),
                  React.createElement('p', { className: "text-xs text-gray-500 dark:text-gray-400" }, new Date(event.timestamp).toLocaleString())
                )
              ))
            )
          )
        )
      ),
      React.createElement('footer', { className: "flex flex-wrap items-center justify-end p-4 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-700 gap-3" },
        canAssignToSelf && React.createElement('button', { onClick: () => assignTicketToSelf(ticket.id), className: "rounded-md bg-white dark:bg-gray-600 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500" }, "Assign to Me"),
        isAssignmentChanged && canManageAssignment && React.createElement('button', { onClick: handleSaveAssignment, className: "rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700" }, "Save Assignment"),
        canStartProgress && React.createElement('button', { onClick: () => updateTicketStatus(ticket.id, Status.IN_PROGRESS), className: "rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700" }, "Start Progress"),
        canMarkAsComplete && React.createElement('button', { onClick: () => updateTicketStatus(ticket.id, Status.COMPLETED), className: "rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700" }, "Mark as Complete"),
        canRequestClosure && React.createElement('button', { onClick: () => requestTicketClosure(ticket.id), className: "rounded-md bg-yellow-500 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-yellow-600" }, "Request Closure"),
        canApproveRejectClosure && (showRejectionInput ? React.createElement('div', { className: "w-full flex items-center gap-2" },
          React.createElement('input', { type: "text", value: rejectionReason, onChange: e => setRejectionReason(e.target.value), placeholder: "Reason for rejection...", className: "block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm sm:text-sm" }),
          React.createElement('button', { onClick: handleRejectClosure, className: "rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700" }, "Confirm Reject"),
          React.createElement('button', { onClick: () => setShowRejectionInput(false), className: "rounded-md bg-white dark:bg-gray-600 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500" }, "Cancel")
        ) : React.createElement(React.Fragment, null,
          React.createElement('button', { onClick: () => setShowRejectionInput(true), className: "flex items-center rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700" }, React.createElement(XCircleIcon, { className: "h-5 w-5 mr-2" }), "Reject Closure"),
          React.createElement('button', { onClick: () => approveTicketClosure(ticket.id), className: "flex items-center rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700" }, React.createElement(CheckCircleIcon, { className: "h-5 w-5 mr-2" }), "Approve Closure")
        )),
        React.createElement('button', { type: "button", onClick: onClose, className: "rounded-md bg-white dark:bg-gray-600 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500" }, "Close")
      )
    )
  );
};

// --- components/TicketItem.tsx ---
const statusStylesItem = {
  [Status.RAISED]: { bg: 'bg-red-100 dark:bg-red-900/50', text: 'text-red-800 dark:text-red-300', border: 'border-red-500' },
  [Status.ASSIGNED]: { bg: 'bg-blue-100 dark:bg-blue-900/50', text: 'text-blue-800 dark:text-blue-300', border: 'border-blue-500' },
  [Status.IN_PROGRESS]: { bg: 'bg-yellow-100 dark:bg-yellow-900/50', text: 'text-yellow-800 dark:text-yellow-300', border: 'border-yellow-500' },
  [Status.COMPLETED]: { bg: 'bg-green-100 dark:bg-green-900/50', text: 'text-green-800 dark:text-green-300', border: 'border-green-500' },
  [Status.PENDING_CLOSURE]: { bg: 'bg-purple-100 dark:bg-purple-900/50', text: 'text-purple-800 dark:text-purple-300', border: 'border-purple-500' },
  [Status.CLOSED]: { bg: 'bg-gray-100 dark:bg-gray-700', text: 'text-gray-800 dark:text-gray-300', border: 'border-gray-500' },
};
const TicketItem = ({ ticket, onViewDetails }) => {
  const { bg, text, border } = statusStylesItem[ticket.status];
  const priorityColor = ticket.priority === 'High' ? 'text-red-500' : ticket.priority === 'Medium' ? 'text-yellow-500' : 'text-green-500';
  return React.createElement('div', { className: `bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col border-l-4 ${border}` },
    React.createElement('div', { className: "p-4 flex-grow" },
      React.createElement('div', { className: "flex justify-between items-start" },
        React.createElement('span', { className: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${bg} ${text}` }, ticket.status),
        React.createElement('span', { className: `font-bold text-sm ${priorityColor}` }, ticket.priority)
      ),
      React.createElement('h3', { className: "mt-3 text-lg font-semibold text-gray-900 dark:text-white truncate", title: ticket.title }, ticket.title),
      React.createElement('p', { className: "mt-1 text-sm text-gray-500 dark:text-gray-400" }, `ID: ${ticket.id}`),
      React.createElement('div', { className: "mt-4 space-y-2 text-sm text-gray-600 dark:text-gray-300" },
        React.createElement('div', { className: "flex items-center" }, React.createElement(TagIcon, { className: "h-4 w-4 mr-2 text-gray-400" }), React.createElement('span', null, ticket.category)),
        React.createElement('div', { className: "flex items-center" }, React.createElement(UserIcon, { className: "h-4 w-4 mr-2 text-gray-400" }), React.createElement('span', null, `${ticket.raisedBy?.name || '...'} (${ticket.store})`)),
        React.createElement('div', { className: "flex items-center" }, React.createElement(CalendarIcon, { className: "h-4 w-4 mr-2 text-gray-400" }), React.createElement('span', null, new Date(ticket.createdAt).toLocaleDateString()))
      )
    ),
    React.createElement('div', { className: "bg-gray-50 dark:bg-gray-700/50 px-4 py-3 rounded-b-lg" },
      React.createElement('button', { onClick: () => onViewDetails(ticket), className: "w-full text-center text-sm font-medium text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200" }, "View Details")
    )
  );
};

// --- components/TicketList.tsx ---
const TicketList = ({ tickets }) => {
  const [selectedTicket, setSelectedTicket] = React.useState(null);
  const handleViewDetails = (ticket) => setSelectedTicket(ticket);
  const handleCloseModal = () => setSelectedTicket(null);
  if (tickets.length === 0) {
    return React.createElement('div', { className: "text-center py-12 bg-white dark:bg-gray-800 rounded-lg shadow" },
      React.createElement(TicketIcon, { className: "mx-auto h-12 w-12 text-gray-400" }),
      React.createElement('h3', { className: "mt-2 text-sm font-medium text-gray-900 dark:text-white" }, "No tickets found"),
      React.createElement('p', { className: "mt-1 text-sm text-gray-500 dark:text-gray-400" }, "Try adjusting your search or filters.")
    );
  }
  return React.createElement(React.Fragment, null,
    React.createElement('div', { className: "grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4" },
      tickets.map(ticket => React.createElement(TicketItem, { key: ticket.id, ticket: ticket, onViewDetails: handleViewDetails }))
    ),
    selectedTicket && React.createElement(TicketDetailsModal, { isOpen: !!selectedTicket, onClose: handleCloseModal, ticket: selectedTicket })
  );
};

// --- components/Dashboard.tsx ---
const Dashboard = () => {
  const context = React.useContext(AppContext);
  const [searchQuery, setSearchQuery] = React.useState('');
  const [statusFilter, setStatusFilter] = React.useState('ALL');
  const [clusterFilter, setClusterFilter] = React.useState('ALL');
  const [specialistFilter, setSpecialistFilter] = React.useState('ALL');
  const [isCreateModalOpen, setCreateModalOpen] = React.useState(false);

  if (!context) return null;
  const { users, tickets, currentUser, deleteAllTickets } = context;

  const clusterManagers = React.useMemo(() => (users || []).filter(u => u.role === Role.CLUSTER_MANAGER), [users]);
  const departmentSpecialists = React.useMemo(() => (users || []).filter(u => u.role === Role.DEPARTMENT_SPECIALIST), [users]);

  const filteredTickets = React.useMemo(() => {
    return (tickets || [])
      .filter(ticket => statusFilter === 'ALL' ? true : ticket.status === statusFilter)
      .filter(ticket => clusterFilter === 'ALL' ? true : ticket.assignedClusterManager?.id === clusterFilter)
      .filter(ticket => specialistFilter === 'ALL' ? true : ticket.assignedTo?.id === specialistFilter)
      .filter(ticket => ticket.title.toLowerCase().includes(searchQuery.toLowerCase()) || ticket.id.toLowerCase().includes(searchQuery.toLowerCase()));
  }, [tickets, statusFilter, clusterFilter, specialistFilter, searchQuery]);


  const handleDownloadCSV = () => {
    const pendingStatuses = [Status.RAISED, Status.ASSIGNED, Status.IN_PROGRESS, Status.PENDING_CLOSURE];
    const ticketsToExport = filteredTickets.filter(ticket => pendingStatuses.includes(ticket.status));
    if (ticketsToExport.length === 0) {
      alert("No pending tickets to export based on current filters.");
      return;
    }
    const headers = ['ID', 'Title', 'Status', 'Priority', 'Category', 'Store', 'Raised By', 'Assigned To', 'Cluster Manager', 'Created At'];
    const csvRows = [headers.join(',')];
    for (const ticket of ticketsToExport) {
      const row = [
        ticket.id, 
        `"${ticket.title.replace(/"/g, '""')}"`, 
        ticket.status, 
        ticket.priority, 
        ticket.category, 
        ticket.store, 
        ticket.raisedBy?.name || 'N/A', 
        ticket.assignedTo?.name || 'Unassigned', 
        ticket.assignedClusterManager?.name || 'N/A', 
        new Date(ticket.createdAt).toISOString()
      ].join(',');
      csvRows.push(row);
    }
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'pending_tickets.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  return React.createElement(React.Fragment, null,
    React.createElement('div', { className: "space-y-6" },
      React.createElement('div', { className: "flex flex-col md:flex-row items-center justify-between gap-4" },
        React.createElement('div', null,
          React.createElement('h1', { className: "text-3xl font-bold tracking-tight text-gray-900 dark:text-white" }, "Ticket Dashboard"),
          React.createElement('p', { className: "text-gray-500 dark:text-gray-400 mt-1" }, `Welcome, ${currentUser.name}. Here are your tickets.`)
        ),
        React.createElement('div', { className: "flex flex-col sm:flex-row items-center gap-2 w-full md:w-auto" },
          currentUser.role === Role.STORE_MANAGER && React.createElement('button', { onClick: () => setCreateModalOpen(true), className: "inline-flex items-center justify-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 w-full" },
            React.createElement(PlusIcon, { className: "h-5 w-5 mr-2" }), "Raise New Ticket"),
          (currentUser.role === Role.ADMIN || currentUser.role === Role.OPERATIONS_HEAD) && React.createElement('button', { onClick: handleDownloadCSV, className: "inline-flex items-center justify-center rounded-md bg-white dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 w-full" },
            React.createElement(ArrowDownTrayIcon, { className: "h-5 w-5 mr-2" }), "Download CSV"),
          currentUser.role === Role.ADMIN && React.createElement('button', { onClick: deleteAllTickets, className: "inline-flex items-center justify-center rounded-md bg-red-600 hover:bg-red-700 px-4 py-2 text-sm font-medium text-white shadow-sm w-full" },
            React.createElement(TrashIcon, { className: "h-5 w-5 mr-2" }), "Delete All Tickets")
        )
      ),
      React.createElement('div', { className: "bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm" },
        React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" },
          React.createElement('div', { className: "relative lg:col-span-1" },
            React.createElement('div', { className: "pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3" }, React.createElement(SearchIcon, { className: "h-5 w-5 text-gray-400" })),
            React.createElement('input', { type: "text", placeholder: "Search by title or ID...", value: searchQuery, onChange: (e) => setSearchQuery(e.target.value), className: "block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 pl-10 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-2" })
          ),
          React.createElement('div', { className: "lg:col-span-1" },
            React.createElement('select', { id: "statusFilter", value: statusFilter, onChange: (e) => setStatusFilter(e.target.value), className: "block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-2" },
              React.createElement('option', { value: "ALL" }, "All Statuses"),
              Object.values(Status).map(s => React.createElement('option', { key: s, value: s }, s))
            )
          ),
          (currentUser.role === Role.ADMIN || currentUser.role === Role.OPERATIONS_HEAD) && React.createElement(React.Fragment, null,
            React.createElement('div', { className: "lg:col-span-1" },
              React.createElement('select', { id: "clusterFilter", value: clusterFilter, onChange: (e) => setClusterFilter(e.target.value), className: "block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-2" },
                React.createElement('option', { value: "ALL" }, "All Clusters"),
                clusterManagers.map(cm => React.createElement('option', { key: cm.id, value: cm.id }, cm.name))
              )
            ),
            React.createElement('div', { className: "lg:col-span-1" },
              React.createElement('select', { id: "specialistFilter", value: specialistFilter, onChange: (e) => setSpecialistFilter(e.target.value), className: "block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-2" },
                React.createElement('option', { value: "ALL" }, "All Specialists"),
                departmentSpecialists.map(ds => React.createElement('option', { key: ds.id, value: ds.id }, ds.name))
              )
            )
          )
        )
      ),
      React.createElement(TicketList, { tickets: filteredTickets })
    ),
    React.createElement(CreateTicketModal, { isOpen: isCreateModalOpen, onClose: () => setCreateModalOpen(false) })
  );
};

// --- components/Header.tsx ---
const Header = () => {
  const context = React.useContext(AppContext);
  if (!context) return null;
  const { currentUser, theme, toggleTheme, users, handleResetData, setActiveView, activeView, openLoginModal, logout } = context;

  const handleUserSelect = (e) => {
    const userId = e.target.value;
    if (userId) {
        const userToLogin = users.find(u => u.id === userId);
        if (userToLogin) {
            openLoginModal(userToLogin);
        }
    }
    e.target.value = ''; // Reset dropdown after selection
  };

  return React.createElement('header', { className: "bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50" },
    React.createElement('div', { className: "container mx-auto px-4 sm:px-6 lg:px-1" },
      React.createElement('div', { className: "flex items-center justify-between h-16" },
        React.createElement('div', { className: "flex items-center space-x-4 min-w-0" },
          React.createElement('div', { className: "flex items-center text-primary-600 dark:text-primary-400" },
            React.createElement('img', { src: "https://www.dropbox.com/scl/fi/3w8cuktwjostzrb21pafw/LOGO-2.png?rlkey=crkvpkwg128csjf52s565avoa&st=aaqqxf4n&raw=1", alt: "Kasam ConneKT Logo", className: "h-8 flex-shrink-0" }),
            React.createElement('span', { className: "ml-2 text-xl font-bold whitespace-nowrap truncate" }, "Kasam Connekt")
          ),
          currentUser && currentUser.role === Role.ADMIN && React.createElement('nav', { className: "hidden md:flex items-center space-x-2" },
            React.createElement('button', { onClick: () => setActiveView('dashboard'), className: `flex items-center px-3 py-2 rounded-md text-sm font-medium ${activeView === 'dashboard' ? 'bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}` },
              React.createElement(TicketIcon, { className: "h-5 w-5 mr-2" }), "Dashboard"),
            React.createElement('button', { onClick: () => setActiveView('analytics'), className: `flex items-center px-3 py-2 rounded-md text-sm font-medium ${activeView === 'analytics' ? 'bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}` },
              React.createElement(ChartBarIcon, { className: "h-5 w-5 mr-2" }), "Analytics"),
            React.createElement('button', { onClick: () => setActiveView('userManagement'), className: `flex items-center px-3 py-2 rounded-md text-sm font-medium ${activeView === 'userManagement' ? 'bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}` },
              React.createElement(UsersIcon, { className: "h-5 w-5 mr-2" }), "Users")
          )
        ),
        React.createElement('div', { className: "flex items-center space-x-2" },
          currentUser ? (
            React.createElement('div', { className: "flex items-center space-x-4" },
                React.createElement('span', { className: "text-sm font-medium text-gray-700 dark:text-gray-200" }, `Welcome, ${currentUser.name}`),
                React.createElement('button', { onClick: logout, className: "p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700", title: "Logout" }, 
                    React.createElement(ArrowLeftOnRectangleIcon, { className: "h-6 w-6" }))
            )
          ) : (
             React.createElement('div', { className: "relative" },
                React.createElement(UserCircleIcon, { className: "pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" }),
                React.createElement('select', { onChange: handleUserSelect, defaultValue: "", className: "pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-sm focus:ring-primary-500 focus:border-primary-500" },
                    React.createElement('option', { value: "", disabled: true }, "Choose the User"),
                    users.map(user => React.createElement('option', { key: user.id, value: user.id }, `${user.name} (${user.role})`))
                )
             )
          ),
          React.createElement('button', { onClick: toggleTheme, className: "p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700", title: "Toggle Theme" },
            theme === 'light' ? React.createElement(MoonIcon, { className: "h-6 w-6" }) : React.createElement(SunIcon, { className: "h-6 w-6" })
          )
        )
      )
    )
  );
};


// --- components/LoginModal.tsx ---
const LoginModal = ({ isOpen, onClose, user, onLogin }) => {
    const [email, setEmail] = React.useState('');
    const [password, setPassword] = React.useState('');
    const [error, setError] = React.useState('');
    const [isLoggingIn, setIsLoggingIn] = React.useState(false);
    const isAdminLogin = user?.role === Role.ADMIN;

    React.useEffect(() => {
        if (isOpen && user) {
            setError('');
            setEmail(user.email || '');
            setPassword('');
            setIsLoggingIn(false);
        }
    }, [isOpen, user]);

    if (!isOpen || !user) return null;

    const handleSubmit = (e) => {
        e.preventDefault();
        setError('');
        setIsLoggingIn(true);
        const success = onLogin(user, isAdminLogin ? email : user.email, password);
        if (success) {
            onClose();
        } else {
            setError("Invalid credentials. Please try again.");
            setIsLoggingIn(false);
        }
    };
    
    return React.createElement('div', { className: "fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4", onClick: onClose },
      React.createElement('div', { className: "bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm", onClick: e => e.stopPropagation() },
        React.createElement('header', { className: "flex flex-col items-center justify-center p-6 border-b border-gray-200 dark:border-gray-700 text-center" },
          React.createElement(UserCircleIcon, { className: "h-16 w-16 text-gray-400" }),
          React.createElement('h2', { className: "text-xl font-bold text-gray-900 dark:text-white mt-4" }, user.name),
          React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400" }, user.role)
        ),
        React.createElement('form', { onSubmit: handleSubmit },
          React.createElement('main', { className: "p-6 space-y-4" },
            isAdminLogin && React.createElement('div', null,
              React.createElement('label', { htmlFor: "email", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Email"),
              React.createElement('input', { type: "email", id: "email", value: email, onChange: e => setEmail(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
            ),
            React.createElement('div', null,
              React.createElement('label', { htmlFor: "password", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Password"),
              React.createElement('input', { type: "password", id: "password", value: password, onChange: e => setPassword(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" })
            ),
            error && React.createElement('p', { className: "mt-2 text-xs text-red-600 dark:text-red-400" }, error)
          ),
          React.createElement('footer', { className: "px-6 pb-6" },
             React.createElement('button', { type: "submit", disabled: isLoggingIn, className: "w-full rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:bg-primary-400" }, isLoggingIn ? 'Logging in...' : 'Login')
          )
        )
      )
    );
};

// --- components/ChangePasswordModal.tsx ---
const ChangePasswordModal = ({ isOpen, onPasswordChange }) => {
    const [newPassword, setNewPassword] = React.useState('');
    const [confirmPassword, setConfirmPassword] = React.useState('');
    const [error, setError] = React.useState('');
    const [isChanging, setIsChanging] = React.useState(false);

    if (!isOpen) return null;

    const handleSubmit = (e) => {
        e.preventDefault();
        if (newPassword.length < 6) {
            setError("Password must be at least 6 characters long.");
            return;
        }
        if (newPassword !== confirmPassword) {
            setError("Passwords do not match.");
            return;
        }
        setError('');
        setIsChanging(true);
        onPasswordChange(newPassword);
    };
    
    return React.createElement('div', { className: "fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center p-4" },
      React.createElement('div', { className: "bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm" },
        React.createElement('header', { className: "p-4 border-b border-gray-200 dark:border-gray-700" },
          React.createElement('h2', { className: "text-xl font-bold text-gray-900 dark:text-white" }, "Set New Admin Password")
        ),
         React.createElement('p', { className: "p-6 text-sm text-gray-600 dark:text-gray-300" }, "For security, you must set a new password for the Admin account before you can proceed. Your temporary password has been disabled."),
        React.createElement('form', { onSubmit: handleSubmit },
          React.createElement('main', { className: "px-6 pb-6 space-y-4" },
             React.createElement('div', null,
              React.createElement('label', { htmlFor: "new-password", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "New Password"),
              React.createElement('input', { type: "password", id: "new-password", value: newPassword, onChange: e => setNewPassword(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm" })
            ),
             React.createElement('div', null,
              React.createElement('label', { htmlFor: "confirm-password", className: "block text-sm font-medium text-gray-700 dark:text-gray-300" }, "Confirm New Password"),
              React.createElement('input', { type: "password", id: "confirm-password", value: confirmPassword, onChange: e => setConfirmPassword(e.target.value), required: true, className: "mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm" })
            ),
            error && React.createElement('p', { className: "text-xs text-red-600 dark:text-red-400" }, error)
          ),
          React.createElement('footer', { className: "px-6 pb-6" },
             React.createElement('button', { type: "submit", disabled: isChanging, className: "w-full rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 disabled:bg-primary-400" }, isChanging ? 'Saving...' : 'Set New Password')
          )
        )
      )
    );
};

// --- App.tsx ---
const getInitialState = (key, defaultValue) => {
    try {
        const savedItem = localStorage.getItem(key);
        if (savedItem) return JSON.parse(savedItem);
    } catch (error) {
        console.error(`Error reading from localStorage key ${key}:`, error);
    }
    return defaultValue;
};

const App = () => {
  const [users, setUsers] = React.useState([]);
  const [tickets, setTickets] = React.useState([]);
  const [categoryAssignments, setCategoryAssignments] = React.useState({});
  
  const [currentUser, setCurrentUser] = React.useState(() => getInitialState('kasam_currentUser', null));
  const [theme, setTheme] = React.useState(() => getInitialState('kasam_theme', 'light'));
  
  const [activeView, setActiveView] = React.useState('dashboard');
  const [isLoginModalOpen, setLoginModalOpen] = React.useState(false);
  const [userToLogin, setUserToLogin] = React.useState(null);
  const [isFirstAdminLogin, setFirstAdminLogin] = React.useState(false);
  const [isLoading, setIsLoading] = React.useState(true);

  // --- Data Seeding and Real-time Sync ---
  React.useEffect(() => {
    const seedDatabase = async () => {
        const configRef = db.collection('meta').doc('config');
        const configDoc = await configRef.get();

        if (configDoc.exists && configDoc.data().seeded) {
            return;
        }
        
        console.log("Database is empty. Seeding initial data...");
        const batch = db.batch();

        INITIAL_USERS.forEach(user => {
            const userRef = db.collection('users').doc(user.id);
            batch.set(userRef, user);
        });

        INITIAL_TICKETS.forEach(ticket => {
            const ticketRef = db.collection('tickets').doc(ticket.id);
            batch.set(ticketRef, ticket);
        });
        
        const assignmentsRef = db.collection('meta').doc('categoryAssignments');
        batch.set(assignmentsRef, INITIAL_CATEGORY_ASSIGNMENTS);

        batch.set(configRef, { seeded: true, version: 1 });
        
        await batch.commit();
        console.log("Initial data seeded successfully.");
    };

    const setupListeners = () => {
        const unsubUsers = db.collection('users').onSnapshot(snapshot => {
            const usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setUsers(usersData);
        });
        const unsubTickets = db.collection('tickets').onSnapshot(snapshot => {
            const ticketsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setTickets(ticketsData);
        });
        const unsubAssignments = db.collection('meta').doc('categoryAssignments').onSnapshot(doc => {
            setCategoryAssignments(doc.data() || {});
        });

        return () => {
            unsubUsers();
            unsubTickets();
            unsubAssignments();
        };
    };

    seedDatabase().then(() => {
        const unsubscribe = setupListeners();
        setIsLoading(false);
        return unsubscribe;
    }).catch(console.error);
    
  }, []);

  // --- Local State Persistence ---
  React.useEffect(() => {
    localStorage.setItem('kasam_currentUser', JSON.stringify(currentUser));
  }, [currentUser]);
  React.useEffect(() => {
    localStorage.setItem('kasam_theme', JSON.stringify(theme));
    document.documentElement.classList.toggle('dark', theme === 'dark');
  }, [theme]);

  // --- Data Hydration ---
  const populatedTickets = React.useMemo(() => {
    if (!users.length || !tickets.length) return [];
    const userMap = new Map(users.map(u => [u.id, u]));
    const findUser = id => userMap.get(id) || null;
    return tickets.map(ticket => ({
      ...ticket,
      raisedBy: findUser(ticket.raisedBy),
      assignedTo: findUser(ticket.assignedTo),
      assignedClusterManager: findUser(ticket.assignedClusterManager),
      closureRequestedBy: findUser(ticket.closureRequestedBy),
      history: (ticket.history || []).map(h => ({ ...h, updatedBy: findUser(h.updatedBy) })),
      comments: (ticket.comments || []).map(c => ({ ...c, user: findUser(c.user) })),
    }));
  }, [tickets, users]);

  const toggleTheme = React.useCallback(() => setTheme(prev => (prev === 'light' ? 'dark' : 'light')), []);

  const handleResetData = async () => {
    if (window.confirm('Are you sure you want to reset all data in Firestore? This cannot be undone.')) {
        console.log("Resetting database...");
        setIsLoading(true);
        // This is a simplified reset for client-side. A proper reset would need cloud functions.
        // We'll just clear the 'seeded' flag and let the seeder run again on reload.
        await db.collection('meta').doc('config').delete();
        localStorage.removeItem('kasam_currentUser');
        localStorage.removeItem('kasam_theme');
        window.location.reload();
    }
  };
  
  // --- Auth Handlers ---
  const openLoginModal = (user) => {
    setUserToLogin(user);
    setLoginModalOpen(true);
  };

  const handleLogin = (user, email, password) => {
    const userInDb = users.find(u => u.id === user.id);
    if (userInDb && userInDb.email === email && userInDb.password === password) {
      if (userInDb.role === Role.ADMIN && !userInDb.passwordChanged) {
          setFirstAdminLogin(true);
      }
      setCurrentUser(userInDb);
      return true;
    }
    return false;
  };
  
  const logout = () => {
      setCurrentUser(null);
      setActiveView('dashboard');
  };
  
  const changePassword = async (userId, newPassword) => {
      await db.collection('users').doc(userId).update({ password: newPassword });
      if (userId === currentUser?.id) {
          setCurrentUser(prev => ({ ...prev, password: newPassword }));
      }
  };

  const changeAdminPassword = async (newPassword) => {
    const adminUser = users.find(u => u.role === Role.ADMIN);
    if(adminUser) {
        await db.collection('users').doc(adminUser.id).update({ 
            password: newPassword,
            passwordChanged: true
        });
        setFirstAdminLogin(false);
        alert("Admin password updated successfully.");
    }
  };
  
  // --- Data Mutation Functions (Firestore) ---
  const createUser = (userData, password) => {
    const id = `user-${Date.now()}`;
    const newUser = { ...userData, id, password, ...(userData.role === Role.ADMIN && {passwordChanged: false}) };
    db.collection('users').doc(id).set(newUser);
  };
  
  const updateUser = (userId, updates) => {
    db.collection('users').doc(userId).update(updates);
  };

  const deleteUser = (userId) => {
    if (currentUser?.id === userId) {
      alert("You cannot delete yourself.");
      return;
    }
    db.collection('users').doc(userId).delete();
  };
  
  const deleteAllTickets = async () => {
    if (currentUser?.role !== Role.ADMIN) {
        alert("You don't have permission for this action.");
        return;
    }
    if (!window.confirm("DANGER: Are you sure you want to delete ALL tickets permanently? This action cannot be undone.")) {
        return;
    }
    
    setIsLoading(true);
    try {
        const ticketsRef = db.collection('tickets');
        let snapshot;
        do {
            snapshot = await ticketsRef.limit(500).get();
            if (snapshot.empty) break;

            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        } while (!snapshot.empty);

        alert("All tickets have been deleted successfully.");
    } catch (error) {
        console.error("Error deleting all tickets:", error);
        alert("An error occurred while deleting tickets. Please check the console.");
    } finally {
        setIsLoading(false);
    }
  };

  const updateCategoryAssignment = (category, userId, isAssigned) => {
      const docRef = db.collection('meta').doc('categoryAssignments');
      db.runTransaction(async (transaction) => {
          const doc = await transaction.get(docRef);
          const data = doc.data() || {};
          const current = data[category] || [];
          const newAssignments = isAssigned
              ? [...new Set([...current, userId])]
              : current.filter(id => id !== userId);
          transaction.update(docRef, { [category]: newAssignments });
      });
  };

  const assignTicketToSelf = (ticketId) => {
    const historyEvent = { status: Status.ASSIGNED, timestamp: new Date().toISOString(), updatedBy: currentUser.id };
    db.collection('tickets').doc(ticketId).update({
        assignedTo: currentUser.id,
        status: Status.ASSIGNED,
        history: firebase.firestore.FieldValue.arrayUnion(historyEvent),
        updatedAt: new Date().toISOString()
    });
  };

  const assignTicketToSpecialist = async (ticketId, specialistId) => {
     const ticketRef = db.collection('tickets').doc(ticketId);
     const doc = await ticketRef.get();
     const ticket = doc.data();

     if (ticket) {
         let newStatus = ticket.status;
         if (specialistId && ticket.status === Status.RAISED) newStatus = Status.ASSIGNED;
         else if (!specialistId) newStatus = Status.RAISED;
         const historyEvent = { status: newStatus, timestamp: new Date().toISOString(), updatedBy: currentUser.id };
         ticketRef.update({
             assignedTo: specialistId || null,
             status: newStatus,
             history: firebase.firestore.FieldValue.arrayUnion(historyEvent),
             updatedAt: new Date().toISOString()
         });
     }
  };

  const getVisibleTickets = React.useMemo(() => {
    if (!currentUser) return [];
    switch (currentUser.role) {
      case Role.STORE_MANAGER: return populatedTickets.filter(t => t.raisedBy?.id === currentUser.id);
      case Role.CLUSTER_MANAGER: return populatedTickets.filter(t => t.assignedClusterManager?.id === currentUser.id);
      case Role.DEPARTMENT_SPECIALIST:
        return populatedTickets.filter(ticket => {
          if (ticket.assignedTo?.id === currentUser.id) return true;
          const specialistCategories = Object.keys(categoryAssignments || {}).filter(cat => categoryAssignments[cat]?.includes(currentUser.id));
          if (!ticket.assignedTo && specialistCategories.includes(ticket.category)) return true;
          return false;
        });
      case Role.OPERATIONS_HEAD:
      case Role.ADMIN: return populatedTickets;
      default: return [];
    }
  }, [currentUser, populatedTickets, categoryAssignments]);

  const createTicket = (newTicketData) => {
    const newTicket = { 
        ...newTicketData, 
        status: Status.RAISED, 
        assignedTo: null,
        closureRequestedBy: null, 
        history: [{ status: Status.RAISED, timestamp: new Date().toISOString(), updatedBy: currentUser.id }], 
        comments: [] 
    };
    db.collection('tickets').doc(newTicket.id).set(newTicket);
  };

  const updateTicketStatus = (ticketId, newStatus) => {
    const historyEvent = { status: newStatus, timestamp: new Date().toISOString(), updatedBy: currentUser.id };
    db.collection('tickets').doc(ticketId).update({ 
        status: newStatus, 
        history: firebase.firestore.FieldValue.arrayUnion(historyEvent), 
        updatedAt: new Date().toISOString() 
    });
  };

  const addComment = (ticketId, commentText) => {
    const newComment = { id: `C-${Date.now()}`, user: currentUser.id, text: commentText, timestamp: new Date().toISOString() };
    db.collection('tickets').doc(ticketId).update({
        comments: firebase.firestore.FieldValue.arrayUnion(newComment)
    });
  };

  const requestTicketClosure = (ticketId) => {
    const historyEvent = { status: Status.PENDING_CLOSURE, timestamp: new Date().toISOString(), updatedBy: currentUser.id };
    db.collection('tickets').doc(ticketId).update({
        status: Status.PENDING_CLOSURE,
        closureRequestedBy: currentUser.id,
        history: firebase.firestore.FieldValue.arrayUnion(historyEvent),
        updatedAt: new Date().toISOString()
    });
  };
  
  const approveTicketClosure = (ticketId) => {
    const historyEvent = { status: Status.CLOSED, timestamp: new Date().toISOString(), updatedBy: currentUser.id };
    db.collection('tickets').doc(ticketId).update({
        status: Status.CLOSED,
        history: firebase.firestore.FieldValue.arrayUnion(historyEvent),
        updatedAt: new Date().toISOString()
    });
  };

  const rejectTicketClosure = (ticketId, reason) => {
    const newComment = { id: `C-${Date.now()}`, user: currentUser.id, text: `Closure Rejected: ${reason}`, timestamp: new Date().toISOString() };
    const historyEvent = { status: Status.IN_PROGRESS, timestamp: new Date().toISOString(), updatedBy: currentUser.id };
    db.collection('tickets').doc(ticketId).update({
        status: Status.IN_PROGRESS,
        comments: firebase.firestore.FieldValue.arrayUnion(newComment),
        history: firebase.firestore.FieldValue.arrayUnion(historyEvent),
        updatedAt: new Date().toISOString(),
        closureRequestedBy: null
    });
  };

  const generateTicketSummary = async (ticket) => {
    if (!process.env.API_KEY) return "API key not configured.";
    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const commentsText = (ticket.comments || []).map(c => `- ${c.user?.name || 'Unknown'}: "${c.text}"`).join('\\n');
      const prompt = `Summarize the following support ticket in 2-3 sentences. Focus on the core issue and the latest status.\\n\\nTicket ID: ${ticket.id}\\nTitle: ${ticket.title}\\nRaised by: ${ticket.raisedBy?.name}\\nStore: ${ticket.store}\\nCategory: ${ticket.category}\\nStatus: ${ticket.status}\\nDescription: ${ticket.description}\\n\\nComments:\\n${commentsText}`;
      const response = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: prompt });
      return response.text;
    } catch (error) {
      console.error("Error generating summary:", error);
      return "Failed to generate summary.";
    }
  };

  const contextValue = React.useMemo(() => ({
    currentUser, theme, toggleTheme, handleResetData, tickets: getVisibleTickets, allTickets: populatedTickets, createTicket, updateTicketStatus, addComment, assignTicketToSelf, assignTicketToSpecialist, requestTicketClosure, approveTicketClosure, rejectTicketClosure, generateTicketSummary, users, createUser, updateUser, deleteUser, categoryAssignments, updateCategoryAssignment,
    activeView, setActiveView, openLoginModal, logout, changePassword, deleteAllTickets
  }), [currentUser, theme, getVisibleTickets, populatedTickets, users, categoryAssignments, activeView]);
  
  if (isLoading) {
    return React.createElement('div', { className: "flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900" },
      React.createElement('div', { className: "flex items-center space-x-2 text-gray-500 dark:text-gray-400" },
        React.createElement(ArrowPathIcon, { className: "h-6 w-6 animate-spin" }),
        React.createElement('span', { className: "text-lg font-medium" }, "Connecting to Kasam Connekt...")
      )
    );
  }

  const renderActiveView = () => {
    if (!currentUser) {
       return React.createElement('div', { className: "flex flex-col items-center justify-center text-center h-[calc(95vh-8rem)]" },
            React.createElement('div', { className: "mb-8" },
                React.createElement('img', { 
                    src: "https://www.dropbox.com/scl/fi/j24evqxph97hho8vudvdk/Kasam-Connekt.png?rlkey=yn315abazpiof90yqbcruqk9d&raw=1", 
                    alt: "Kasam Connekt Logo", 
                    className: "h-32" 
                }) 
            ),
            React.createElement('div', null,
                React.createElement('h1', { className: "text-2xl font-bold tracking-tight text-gray-900 dark:text-white" }, "Welcome to Kasam Connekt"),
                React.createElement('p', { className: "mt-4 text-sm text-gray-600 dark:text-gray-300" }, "Please select a user from the top right to log in.")
            )
       );
    }
    switch (activeView) {
      case 'dashboard': return React.createElement(Dashboard, null);
      case 'analytics': if (currentUser.role === Role.ADMIN) return React.createElement(AdminAnalytics, null); break;
      case 'userManagement': if (currentUser.role === Role.ADMIN) return React.createElement(UserManagement, null); break;
    }
    return React.createElement('div', { className: "text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-md" },
      React.createElement('h2', { className: "text-2xl font-bold text-red-500" }, "Access Denied"),
      React.createElement('p', { className: "mt-2 text-gray-600 dark:text-gray-300" }, "You do not have permission to view this page.")
    );
  };

  return React.createElement(AppContext.Provider, { value: contextValue },
    React.createElement('div', { className: "min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300" },
      React.createElement(Header, null),
      React.createElement('main', { className: "p-4 sm:p-6 lg:p-8" }, renderActiveView()),
      React.createElement(LoginModal, { 
          isOpen: isLoginModalOpen, 
          onClose: () => setLoginModalOpen(false), 
          user: userToLogin, 
          onLogin: handleLogin,
      }),
      React.createElement(ChangePasswordModal, {
          isOpen: isFirstAdminLogin,
          onPasswordChange: changeAdminPassword
      })
    )
  );
};

// --- index.tsx ---
const rootElement = document.getElementById('root');
if (rootElement) {
  const root = ReactDOM.createRoot(rootElement);
  root.render(React.createElement(React.StrictMode, null, React.createElement(App, null)));
}
    </script>
  </body>
</html>

